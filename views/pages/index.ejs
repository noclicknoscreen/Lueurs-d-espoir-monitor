<!-- views/pages/index.ejs -->

<!DOCTYPE html>
<html lang="fr">
<head>
    <% include ../partials/head %>
</head>
<body class="container">

    <header>
        <% include ../partials/header %>
    </header>

    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-6 col-sm-4 col-md-4">
                <img src="images/pupitre.png" class="pupitre" id="pupitre1" />
                <div type="button" class="btn btn-default btn-lg"><span id="images_count_1">0</span></div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-4">
                <img src="images/pupitre.png" class="pupitre" id="pupitre2" />
                <div type="button" class="btn btn-default btn-lg"><span id="images_count_2">0</span></div>
            </div>
            <div class="col-xs-6 col-sm-4 col-md-4">
                <img src="images/pupitre.png" class="pupitre" id="pupitre3" />
                <div type="button" class="btn btn-default btn-lg"><span id="images_count_3">0</span></div>
            </div>
        </div>
        <div class="row">
            <!-- pupitre 1 -->
            <div class="col-xs-6 col-sm-4 col-md-4">
                <table class="table table-striped">
                    <tr class="success" id="pupitre_1"><th>Pupitre 1</th>
                        <td>
                            <button type="button" id="cleanup_1" class="commande btn btn-warning btn-xs" title="Effacer les images pour faire de la place"><span class="glyphicon glyphicon-fire"></span></button>
                            <button type="button" id="reboot_1" class="commande btn btn-primary btn-xs" title="re-démarrer le système"><span class="glyphicon glyphicon-repeat"></span></button>
                            <button type="button" id="halt_1" class="commande btn btn-danger btn-xs" title="Arrêter le système"><span class="glyphicon glyphicon-off"></span></button>
                        </td>
                    </tr>
                    <tr class="danger">
                        <td colspan="2" id="error_1"></td> 
                    </tr>
                    <tr>
                        <th>Espace disponible</th><td id="available_space_1"></td>
                    </tr>
                    <tr>
                        <th>service <%= app_title %></th><td id="lues_service_1"></td>
                    </tr>
                    <tr>
                        <th>service DHCP</th><td id="dhcp_service_1"></td>
                    </tr>
                </table>
            </div>

            <!-- pupitre 2 -->
            <div class="col-xs-6 col-sm-4 col-md-4">
                <table class="table table-striped">
                    <tr class="success" id="pupitre_2"><th>Pupitre 2</th>
                        <td>
                            <button type="button" id="cleanup_2" class="commande btn btn-warning btn-xs" title="Effacer les images pour faire de la place"><span class="glyphicon glyphicon-fire"></span></button>
                            <button type="button" id="reboot_2" class="commande btn btn-primary btn-xs" title="re-démarrer le système"><span class="glyphicon glyphicon-repeat"></span></button>
                            <button type="button" id="halt_2" class="commande btn btn-danger btn-xs" title="Arrêter le système"><span class="glyphicon glyphicon-off"></span></button>
                        </td>
                    </tr>
                    <tr class="danger">
                        <td colspan="2" id="error_2"></td> 
                    </tr>
                    <tr>
                        <th>Espace disponible</th><td id="available_space_2"></td>
                    </tr>
                    <tr>
                        <th>service <%= app_title %></th><td id="lues_service_2"></td>
                    </tr>
                </table>
            </div>

            <!-- pupitre 3 -->
            <div class="col-xs-6 col-sm-4 col-md-4">
                <table class="table table-striped">
                    <tr class="success" id="pupitre_3"><th>Pupitre 3</th>
                        <td>
                            <button type="button" id="cleanup_3" class="commande btn btn-warning btn-xs" title="Effacer les images pour faire de la place"><span class="glyphicon glyphicon-fire"></span></button>
                            <button type="button" id="reboot_3" class="commande btn btn-primary btn-xs" title="re-démarrer le système"><span class="glyphicon glyphicon-repeat"></span></button>
                            <button type="button" id="halt_3" class="commande btn btn-danger btn-xs" title="Arrêter le système"><span class="glyphicon glyphicon-off"></span></button>
                        </td>
                    </tr>
                    <tr class="danger">
                        <td colspan="2" id="error_3"></td> 
                    </tr>
                    <tr>
                        <th>Espace disponible</th><td id="available_space_3"></td>
                    </tr>
                    <tr>
                        <th>service <%= app_title %></th><td id="lues_service_3"></td>
                    </tr>
                </table>
            </div>

        </div>
    </div>

    <footer>
        <% include ../partials/footer %>
    </footer>
    <!-- Scripts to be included in a js library futher more... -->
    <script type="text/javascript">
        $(document).ready( function() {
            var DEVICE_LIST = {
                                rasp1 : { host: "192.168.1.11", port: '9000', path: '/monitor' }, 
                                rasp2 : { host: "192.168.1.12", port: '9000', path: '/monitor' }, 
                                rasp3 : { host: "192.168.1.13", port: '9000', path: '/monitor' }, 
                                rasp4 : { host: "192.168.1.14", port: '9000', path: '/monitor' }
                            };
            var LABEL_OK = "<span class='glyphicon glyphicon-thumbs-up'></span>",
                CSS_OK = "success",
                LABEL_KO = "<span class='glyphicon glyphicon-thumbs-down'></span>",
                CSS_KO = "danger";

            // Les valeurs monitorées sauvegardées
            // var images_count_value = 0,
            //     available_space_value = 0,
            //     lues_service_value = 0,
            //     dhcp_service_value = 0;

            function monitor(device, display_callback) {
                var idx = device.replace(/[-#A-z]/g, "");
                $("#error_" + idx).hide();
                $("#pupitre_" + idx).removeClass("success").removeClass("danger").addClass("warning");

                options = DEVICE_LIST[device];
                var url = 'http://' + options.host + ':' + options.port + options.path;
                console.log(' calling rasp api @' + device + ": url=" + url);
                // Appel ajax du device monitoré
                $.ajax({
                    url: url,
                    type: 'GET',
                    success : function(response){
                         if (response != "" && response != undefined) {
                            // var r = JSON.parse(response);
                            var r = response;
                            if (r.stderr != "") {
                                console.log("error : " + r.stderr);
                            } else {
                                // images_count_value = r.data.images_count;
                                // available_space_value = r.data.available_space;
                                // lues_service_value = r.data.lues_service;
                                // dhcp_service_value = r.data.dhcp_service;
                                display_callback(idx, r);
                            }
                        } else {
                            console.log("La réponse JSON est vide...");
                            display_error(idx, "Server is responding, but no response was sent.");
                        }
                    },
                    error : function(response){
                        if (response.status == 404) {
                            display_error(idx, "Monitoring service may be down !");
                        }
                        display_callback(idx);
                         
                    }
                });
            }

            // Gestion des erreurs 
            function display_error(idx, err) {
                $("#error_" + idx).text(err).show();
                $("#pupitre_" + idx).removeClass("success").removeClass("warning").addClass("danger");
            }

            // Callback de mise en page et affichage des données.
            var display_data = function(idx, r) {
                $("#pupitre_" + idx).removeClass("warning").removeClass("danger").addClass("success")
                $("#images_count_" + idx).text(r.data.images_count);
                $("#available_space_" + idx).text(r.data.available_space + "Mo");

                var css_class = CSS_KO, label = LABEL_KO;
                if (r.data.lues_service == "1") { 
                    css_class = CSS_OK; 
                    label = LABEL_OK;
                }
                $("#lues_service_" + idx).html('<span class="label label-' + css_class + '">' +  label + '</span>');

                if ($("#dhcp_service_"+idx)) {
                    css_class = CSS_KO;
                    label = LABEL_KO;
                    if (r.data.dhcp_service == "1") { 
                        css_class = CSS_OK; 
                        label = LABEL_OK;
                    }
                    $("#dhcp_service_" + idx).html('<span class="label label-' + css_class + '">' +  label + '</span>');
                }

            }

            function send_command(idx, cmd) {
                options = DEVICE_LIST['rasp' + idx];
                var url = 'http://' + options.host + ':' + options.port + '/' + cmd;
                console.log(' Command ' + cmd + ' sent to  #rasp' + idx + ": url=" + url);
                // Appel ajax du device commandé
                $.ajax({
                    url: url,
                    type: 'GET',
                    success : function(response){
                        console.log("commande '"+cmd+"' lancée...");
                    },
                    error : function(response){

                    }
                });
            }

            $(".commande").click(function(){
                var t = $(this).attr("id").split("_");
                send_command(t[1], t[0]);
            });            

            setInterval(function(){
                monitor("rasp1", display_data);
            }, 5000);

            setInterval(function(){
                monitor("rasp2", display_data);
            }, 5000);

            setInterval(function(){
                monitor("rasp3", display_data);
            }, 5000);

            // monitor("rasp1", display_data);
            // monitor("rasp2", display_data);
            // monitor("rasp3", display_data);

         });
 

    </script>

</body>
</html>